{% extends "layout.html" %}
{% block content %}
    <div class="p-5 mb-4 rounded-3 card">
        <div class="container-fluid py-5 text-center"> <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="Cyber Club Logo" style="width: 120px; margin-bottom: 20px;" class="rounded-circle">
            
            <h1 class="display-5 fw-bold">Welcome to the Cyber Club</h1>
            <p class="fs-4">Lock it down, Protect it up.</p>
        </div>
    </div>
    
    {% if current_user.is_authenticated %}
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card h-100">
                    <div class="card-body">
                        <h3 class="card-title">My Attendance Dashboard</h3>
                        <canvas id="attendanceBarGraph"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <h3 class="card-title">Overall Stats</h3>
                        <div id="stats-container">
                            <p class="fs-4">Loading stats...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <h2 class="mt-5">Upcoming Events</h2>
        <div class="list-group">
            {% for event in events %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1">{{ event.title }}</h5>
                    <p class="mb-1">{{ event.description }}</p>
                    <small>{{ event.date.strftime('%A, %B %d, %Y') }}</small>
                </div>
                {% if event.id in attended_event_ids %}
                    <span class="badge bg-success rounded-pill"><i class="fas fa-check"></i> Attended</span>
                {% else %}
                    <a href="{{ url_for('mark_attendance', event_id=event.id) }}" class="btn btn-primary">Mark as Present</a>
                {% endif %}
            </div>
            {% else %}
            <p>No upcoming events scheduled. Check back later!</p>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center">
            <h3>Please <a href="{{ url_for('login') }}">login</a> or <a href="{{ url_for('register') }}">register</a> to view events and manage your attendance.</h3>
        </div>
    {% endif %}
{% endblock content %}

{% block scripts %}
<script>
    {% if current_user.is_authenticated %}
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/attendance-data')
            .then(response => response.json())
            .then(data => {
                // Update Stats
                const percentage = data.total > 0 ? ((data.attended / data.total) * 100).toFixed(1) : 0;
                const statsContainer = document.getElementById('stats-container');
                statsContainer.innerHTML = `
                    <p class="fs-4">Attended: <span class="badge bg-success">${data.attended}</span></p>
                    <p class="fs-4">Missed: <span class="badge bg-danger">${data.missed}</span></p>
                    <p class="fs-4">Total Events: <span class="badge bg-info">${data.total}</span></p>
                    <hr>
                    <p class="fs-3">Attendance: <strong>${percentage}%</strong></p>
                `;

                // Render Bar Graph
                const ctx = document.getElementById('attendanceBarGraph').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Attended', 'Missed'],
                        datasets: [{
                            label: 'Sessions',
                            data: [data.attended, data.missed],
                            backgroundColor: ['#2780E3', '#E95420'] // Blue and Orange
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#e0e0e0' } },
                            x: { ticks: { color: '#e0e0e0' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            });
    });
    {% endif %}
</script>
{% endblock scripts %}
